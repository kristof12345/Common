@namespace Common.Web

@using Common.Application
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Charts

<div class="series-chart" style="height: 450px;">
    @if (Visibility == "hidden")
    {
        <LoadingIndicator />
    }

    @if (Data != null)
    {
        <div class="chart">
            <SfChart Theme=@Theme.Material Background=@Colors.Transparent Height="350" CustomClass=@Visibility>

                <ChartPrimaryXAxis ValueType=@Syncfusion.Blazor.Charts.ValueType.DateTimeCategory IntervalType=@ChartIntervalType LabelFormat=@DateFormat LabelIntersectAction=@LabelIntersectAction.Hide EdgeLabelPlacement=@EdgeLabelPlacement.Shift>
                    <ChartAxisMajorGridLines Width="0"></ChartAxisMajorGridLines>
                </ChartPrimaryXAxis>

                <ChartPrimaryYAxis ValueType="Syncfusion.Blazor.Charts.ValueType.Double" LabelFormat=@ValueFormat OpposedPosition="true" LabelIntersectAction=@LabelIntersectAction.Hide RangePadding=@ChartRangePadding.Additional Minimum=@Minimum Maximum=@Maximum>
                    <ChartAxisMajorGridLines Width="1"></ChartAxisMajorGridLines>
                </ChartPrimaryYAxis>

                <ChartSeriesCollection>
                    @foreach (var serie in RangedData)
                    {
                        <ChartSeries DataSource=@serie.Data Fill=@serie.Color XName="Date" YName="Value" Type=@Type Width="3" />
                    }
                </ChartSeriesCollection>

            </SfChart>
        </div>
        @if (ShowSelector)
        {
            <div class=@("range " + Visibility)>
                <SfRangeNavigator Value=@Range ValueChanged=@RangeChanged ValueType="Syncfusion.Blazor.Charts.RangeValueType.DateTime" Theme=@Theme.Material Height="100" IntervalType=@RangeIntervalType Interval="1" LabelFormat=@RangeIntervalType.ToFormat()>
                    <RangeNavigatorEvents Loaded=@OnRangeLoaded></RangeNavigatorEvents>
                    <RangeNavigatorSeriesCollection>
                        @foreach (var serie in Data)
                        {
                            <RangeNavigatorSeries DataSource=@serie.Data Fill=@serie.Color Type=@RangeNavigatorType.Line Width="2" XName="Date" YName="Value" />
                        }
                    </RangeNavigatorSeriesCollection>
                </SfRangeNavigator>
            </div>
        }
    }
</div>

@if (ShowLegend)
{
    <div class="legend">
        <DiagramLegend Data=@DiagramLegend />
    </div>
}

@code
{
    [Parameter]
    [EditorRequired]
    public IEnumerable<ChartDataSeries> Data { get; set; }

    [Parameter]
    public bool ShowLegend { get; set; } = false;

    [Parameter]
    public bool ShowSelector { get; set; } = true;

    [Parameter]
    public ChartSeriesType Type { get; set; } = ChartSeriesType.Line;

    [Parameter]
    public IntervalType ChartIntervalType { get; set; } = IntervalType.Auto;

    [Parameter]
    public RangeIntervalType RangeIntervalType { get; set; } = RangeIntervalType.Auto;

    [Parameter]
    public string DateFormat { get; set; } = "  yyyy.MM.dd  ";

    [Parameter]
    public string ValueFormat { get; set; } = "{value}";

    [Parameter]
    public DateTime? StartDate { get; set; } = null;

    [Parameter]
    public DateTime? EndDate { get; set; } = null;

    [Parameter]
    public decimal? Minimum { get; set; } = null;

    [Parameter]
    public decimal? Maximum { get; set; } = null;

    private string Visibility { get; set; } = "hidden";

    private DateTime[] Range { get; set; }

    private string Height { get => ShowSelector ? "450px" : "350px"; }

    public IEnumerable<ChartDataSeries> RangedData { get => Data.Select(series => new ChartDataSeries { Id = series.Id, Data = series.Data.Where(d => d.Date >= Range[0] && d.Date <= Range[1]), Color = series.Color }); }

    private IEnumerable<ChartData> DiagramLegend { get => Data?.Select(series => new ChartData { Label = series.Id, Color = series.Color }); }

    protected override void OnParametersSet()
    {
        if (Data != null)
        {
            if (!ShowSelector) Visibility = "visible";
            if (!StartDate.HasValue) StartDate = DateTime.MinValue;
            if (!EndDate.HasValue) EndDate = DateTime.MaxValue;
            Range = new DateTime[] { StartDate.Value, EndDate.Value };
        }
    }

    private void RangeChanged(object args)
    {
        Range = (DateTime[])args;
    }

    private void OnRangeLoaded(object args)
    {
        Visibility = "visible";
    }
}